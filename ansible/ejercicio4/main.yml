---
- name: Instalar prometheus
  apt:
    name: prometheus
    update_cache: yes
    state: present

- name: Configurar Prometheus
  server:
    name: localhost
    port: 9090

- name: Instalar Node Exporter 
  apt:
    name: prometheus-node-exporter
    state: present

- name: Habilitar y iniciar Node Exporter
  systemd:
    name: prometheus-node-exporter
    state: started
    enabled: yes

- name: Asegurar que Prometheus est√© monitoreando el Node Exporter
  lineinfile:
    path: /etc/prometheus/prometheus.yml
    regexp: '^  - targets:'
    line: '  - targets: ["localhost:5000", "localhost:9100"]'
    insertafter: '# scrape_configs'
    state: present
  notify:
    - Reiniciar Prometheus

- name: Instalar Grafana
  apt:
    name: grafana
    state: present

- name: Iniciar y habilitar el servicio Grafana
  systemd:
    name: grafana-server
    state: started
    enabled: yes